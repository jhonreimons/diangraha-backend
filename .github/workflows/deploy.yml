name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "=== STAGE 1: Git Pull Latest Code ==="
            cd /srv/myapp

            if [ -d "diangraha-backend" ]; then
                cd diangraha-backend
                git fetch origin
                git reset --hard origin/main
                git clean -fd
                echo "✅ Latest code pulled"
            else
                git clone https://github.com/jhonreimons/diangraha-backend.git
                cd diangraha-backend
                echo "✅ Code cloned"
            fi

            echo "=== STAGE 2: Create Environment Config (.env) ==="
            cat > .env <<EOL
            # Database Credentials
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            MYSQL_USER=${{ secrets.MYSQL_USER }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}

            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}

            # AWS S3 Credentials
            AMAZON_ACCESS_KEY=${{ secrets.AMAZON_ACCESS_KEY }}
            AMAZON_SECRET_KEY=${{ secrets.AMAZON_SECRET_KEY }}
            AMAZON_BUCKET_NAME=${{ secrets.AMAZON_BUCKET_NAME }}
            AMAZON_REGION=${{ secrets.AMAZON_REGION }}
            EOL
            echo "✅ Environment variables created"

            echo "=== STAGE 3: Stop Existing Containers ==="
            docker stop diangraha-backend || true
            docker rm diangraha-backend || true

            echo "=== STAGE 4: Build Spring Boot JAR ==="
            rm -rf target/ || true
            ./mvnw clean package -DskipTests

            if [ ! -f "target/diangraha-backend-0.0.1-SNAPSHOT.jar" ]; then
                echo "❌ Build failed: JAR file missing!"
                exit 1
            fi
            echo "✅ JAR build successful"

            echo "=== STAGE 5: Test JAR Application Startup ==="
            timeout 20s java -jar target/diangraha-backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=test &
            sleep 10

            if ! pgrep -f "diangraha-backend"; then
                echo "❌ JAR failed to start"
                exit 1
            fi
            echo "✅ JAR test passed"
            pkill -f "diangraha-backend"

            echo "=== STAGE 6: Build Docker Container ==="
            docker rmi diangraha-backend-app || true
            docker compose build app
            echo "✅ Docker image built"

            echo "=== STAGE 7: Deploy Container ==="
            docker compose up -d app
            echo "✅ Container deployed"

            echo "=== STAGE 8: Validate Deployment ==="
            sleep 5
            docker compose ps
            docker compose logs app --tail=30

            echo "=== HEALTH CHECK ==="
            if curl -f http://localhost:8080/api/brands > /dev/null; then
                echo "✅ Deployment succeeded!"
            else
                echo "❌ App not responding"
                docker compose logs app --tail=100
                exit 1
            fi
