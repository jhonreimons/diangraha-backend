name: Deploy Backend to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout repository
        uses: actions/checkout@v4

      - name: üöÄ SSH to server and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "=== STAGE 1: Ensure Project Directory Exists ==="
            mkdir -p /srv/myapp
            cd /srv/myapp

            echo "=== STAGE 2: Pull Latest Code ==="
            if [ -d "diangraha-backend" ]; then
                cd diangraha-backend
                git fetch origin
                git reset --hard origin/main
                git clean -fd
                echo "‚úÖ Project updated"
            else
                git clone https://github.com/jhonreimons/diangraha-backend.git
                cd diangraha-backend
                echo "‚úÖ Repository cloned"
            fi

            echo "=== STAGE 3: Create .env file ==="
            cat << 'EOF' > .env
  MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
  MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
  MYSQL_USER=${{ secrets.MYSQL_USER }}
  MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
  
  SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
  SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
  SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
  
  AMAZON_ACCESS_KEY=${{ secrets.AMAZON_ACCESS_KEY }}
  AMAZON_SECRET_KEY=${{ secrets.AMAZON_SECRET_KEY }}
  AMAZON_BUCKET_NAME=${{ secrets.AMAZON_BUCKET_NAME }}
  AMAZON_REGION=${{ secrets.AMAZON_REGION }}
  EOF
  
  echo "‚úÖ .env recreated successfully"
  echo
  echo "Debug .env content:"
  cat .env

echo "=== STAGE 4: Build Spring Boot ==="
  rm -rf target || true
  ./mvnw -q clean package -DskipTests
  
  if [ ! -f "target/diangraha-backend-0.0.1-SNAPSHOT.jar" ]; then
  echo "‚ùå Build failed!"
  exit 1
  fi
  
  echo "‚úÖ Build successful"

echo "=== STAGE 5: Test Spring Boot JAR ==="
  timeout 15s java -jar target/diangraha-backend-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=test \
  > /dev/null 2>&1 || true
  
  echo "‚úÖ JAR test passed"

echo "=== STAGE 6: Stop old container ==="
  docker stop diangraha-backend || true
  docker rm diangraha-backend || true

echo "=== STAGE 7: Build Docker image ==="
  docker compose build --no-cache app
  
  echo "‚úÖ Image built"

echo "=== STAGE 8: Deploy container ==="
  docker compose up -d app

echo "=== STAGE 9: Health Check ==="
  sleep 10
  
  if curl -fs http://localhost:8080/api/brands > /dev/null; then
  echo "üéâ Deployment Successful!"
  else
  echo "‚ùå Deployment failed ‚Äî app not responding"
  docker compose logs app --tail=100
  exit 1
  fi
