name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}

          envs: |
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            MYSQL_USER=${{ secrets.MYSQL_USER }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            AMAZON_ACCESS_KEY=${{ secrets.AMAZON_ACCESS_KEY }}
            AMAZON_SECRET_KEY=${{ secrets.AMAZON_SECRET_KEY }}
            AMAZON_BUCKET_NAME=${{ secrets.AMAZON_BUCKET_NAME }}
            AMAZON_REGION=${{ secrets.AMAZON_REGION }}

          script: |
            set -e

            echo "=== Checking dependencies (Docker/Java/Git) ==="
            for cmd in docker git java; do
              if ! command -v $cmd >/dev/null; then
                echo "‚ùå Missing dependency: $cmd"
                exit 1
              fi
            done
            echo "‚úÖ Dependencies OK"

            echo "=== STAGE 1: Pull latest code ==="
            mkdir -p /srv/myapp
            cd /srv/myapp

            if [ -d "diangraha-backend" ]; then
              cd diangraha-backend
              git fetch origin main
              git reset --hard origin/main
              git clean -fd
              echo "‚úÖ Latest code pulled"
            else
              git clone https://github.com/jhonreimons/diangraha-backend.git
              cd diangraha-backend
              echo "‚úÖ Repository cloned"
            fi

            echo "=== Ensure mvnw executable ==="
            chmod +x mvnw || true

            echo "=== STAGE 2: Generate .env ==="
            cat <<EOF > .env
            MYSQL_DATABASE=$MYSQL_DATABASE
            MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
            MYSQL_USER=$MYSQL_USER
            MYSQL_PASSWORD=$MYSQL_PASSWORD
            
            SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL
            SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME
            SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD
            
            AWS_ACCESS_KEY=$AMAZON_ACCESS_KEY
            AWS_SECRET_KEY=$AMAZON_SECRET_KEY
            AWS_REGION=$AMAZON_REGION
            AWS_S3_BUCKET_NAME=$AMAZON_BUCKET_NAME
            EOF
            echo "‚úÖ .env generated"
            
            # Remove possible indentations
            sed -i 's/^[ \t]*//' .env

          echo "=== STAGE 3: Stop old containers ==="
            docker stop diangraha-backend || true
            docker rm diangraha-backend || true

          echo "=== STAGE 4: Build JAR ==="
            rm -rf target/
            ./mvnw clean package -DskipTests -U
            
            if [ ! -f "target/diangraha-backend-0.0.1-SNAPSHOT.jar" ]; then
          echo "‚ùå ERROR: Build failed, JAR missing"
            exit 1
            fi
            
            echo "‚úÖ JAR built successfully"

          echo "=== STAGE 5: Test JAR on port 8081 ==="
            set -a
            source .env
            set +a
            
            timeout 60s java -jar target/diangraha-backend-0.0.1-SNAPSHOT.jar \
            --server.port=8081 > jar-test.log 2>&1 &
            JAR_PID=$!
            
            echo "Waiting for Spring Boot to start..."
            for i in {1..12}; do
            if ps -p $JAR_PID >/dev/null; then
            if grep -q "Started" jar-test.log; then
            echo "‚úÖ JAR started"
            break
            fi
            echo "‚è≥ ($i/12) Starting..."
            sleep 5
            else
            echo "‚ùå JAR process terminated"
            break
            fi
            done
            
            if ! ps -p $JAR_PID >/dev/null; then
            echo "‚ùå JAR FAILED TO START"
            tail -n 200 jar-test.log
            exit 1
            fi
            
            kill $JAR_PID || true
            echo "‚úÖ JAR test stopped"

          echo "=== STAGE 6: Docker Compose Build & Deploy ==="
            docker compose build --no-cache app
            docker compose up -d app

          echo "=== STAGE 7: Health check ==="
            sleep 15
            
            if curl -fs http://localhost:8080/api/brands >/dev/null; then
            echo "üéâ DEPLOYMENT SUCCESSFUL!"
            else
            echo "‚ùå HEALTH CHECK FAILED ‚Äî Printing logs"
            docker compose logs app --tail=100
            exit 1
            fi
