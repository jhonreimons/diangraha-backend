name: Deploy Backend (Spring Boot + Docker Compose)

on:
  push:
    branches:
      - main   # otomatis deploy setiap ada push ke main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Connect to VPS and deploy Spring Boot
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}

          script: |
            set -e

            # === Configuration ===
            APP_DIR="$HOME/diangraha-backend"

            echo ">>> Ensure application directory exists"
            mkdir -p "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo ">>> Fresh clone"
              rm -rf "$APP_DIR"
              git clone https://github.com/jhonreimons/diangraha-backend.git "$APP_DIR"
            fi

            echo ">>> Enter application folder"
            cd "$APP_DIR"

            echo ">>> Pull latest version"
            git checkout main
            git fetch origin main
            git reset --hard origin/main

            echo ">>> Generate .env file"
            cat <<EOF > .env
  MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
  MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
  MYSQL_USER=${{ secrets.MYSQL_USER }}
  MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
  
  SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
  SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
  SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
  
  AMAZON_ACCESS_KEY=${{ secrets.AMAZON_ACCESS_KEY }}
  AMAZON_SECRET_KEY=${{ secrets.AMAZON_SECRET_KEY }}
  AMAZON_BUCKET_NAME=${{ secrets.AMAZON_BUCKET_NAME }}
  AMAZON_REGION=${{ secrets.AMAZON_REGION }}
  EOF
  echo "âœ… .env created"
  
  echo ">>> Cleaning JAR build"
  rm -rf target
  
  echo ">>> Build JAR using Maven Wrapper"
  ./mvnw -q clean package -DskipTests
  
  echo ">>> Run docker compose"
  docker compose up -d --build --remove-orphans
  
  echo ">>> Cleanup unused images"
  docker image prune -f
  
  echo "âœ… Deployment SUCCESSFUL!"
